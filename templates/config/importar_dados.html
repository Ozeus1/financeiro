{% extends "base.html" %}

{% block title %}Importar Dados do Sistema Desktop{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4><i class="bi bi-download"></i> Importar Dados do Sistema Desktop</h4>
            </div>
            <div class="card-body">
                <!-- NOVO: Upload de Arquivo SQLite - DESPESAS -->
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> üì§ Fazer Upload do Banco de Despesas</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <strong>‚úÖ Recomendado:</strong> Envie o arquivo <code>financas.db</code> do sistema desktop para sincronizar as despesas.
                            <br><strong>Vantagem:</strong> N√£o precisa abrir porta do PostgreSQL!
                        </div>

                        <form method="POST" enctype="multipart/form-data" id="formUploadDespesas">
                            <input type="hidden" name="tipo_importacao" value="upload">
                            <input type="hidden" name="tipo_banco" value="despesas">

                            <div class="mb-3">
                                <label for="arquivo_sqlite_despesas" class="form-label">
                                    <strong>Selecione o arquivo do banco de despesas</strong>
                                </label>
                                <input
                                    type="file"
                                    class="form-control"
                                    id="arquivo_sqlite_despesas"
                                    name="arquivo_sqlite_despesas"
                                    accept=".db,.sqlite,.sqlite3"
                                    required
                                >
                                <small class="text-muted">
                                    Arquivo: <code>financas.db</code> (localizado na pasta do sistema desktop)
                                </small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>Modo de Importa√ß√£o</strong></label>

                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="modo_importacao"
                                        id="modo_parcial_despesas"
                                        value="parcial"
                                        checked
                                    >
                                    <label class="form-check-label" for="modo_parcial_despesas">
                                        <strong>Parcial (Adicionar)</strong>
                                        <br>
                                        <small class="text-muted">Adiciona os dados do arquivo aos dados existentes (recomendado)</small>
                                    </label>
                                </div>

                                <div class="form-check mt-2">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="modo_importacao"
                                        id="modo_total_despesas"
                                        value="total"
                                    >
                                    <label class="form-check-label" for="modo_total_despesas">
                                        <strong>Total (Substituir)</strong>
                                        <br>
                                        <small class="text-danger">‚ö†Ô∏è APAGA todas as suas DESPESAS no servidor e substitui pelos dados do arquivo</small>
                                    </label>
                                </div>
                            </div>

                            <div class="alert alert-warning d-none" id="avisoTotalDespesas">
                                <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> O modo TOTAL ir√° apagar TODAS as suas DESPESAS antes de importar. Use apenas se tiver certeza!
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-danger btn-lg">
                                    <i class="bi bi-cloud-upload"></i> üì§ Fazer Upload e Importar Despesas
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- NOVO: Upload de Arquivo SQLite - RECEITAS -->
                <div class="card mb-4 border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> üì§ Fazer Upload do Banco de Receitas</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <strong>‚úÖ Recomendado:</strong> Envie o arquivo <code>financas_receita.db</code> do sistema desktop para sincronizar as receitas.
                            <br><strong>Vantagem:</strong> N√£o precisa abrir porta do PostgreSQL!
                        </div>

                        <form method="POST" enctype="multipart/form-data" id="formUploadReceitas">
                            <input type="hidden" name="tipo_importacao" value="upload">
                            <input type="hidden" name="tipo_banco" value="receitas">

                            <div class="mb-3">
                                <label for="arquivo_sqlite_receitas" class="form-label">
                                    <strong>Selecione o arquivo do banco de receitas</strong>
                                </label>
                                <input
                                    type="file"
                                    class="form-control"
                                    id="arquivo_sqlite_receitas"
                                    name="arquivo_sqlite_receitas"
                                    accept=".db,.sqlite,.sqlite3"
                                    required
                                >
                                <small class="text-muted">
                                    Arquivo: <code>financas_receita.db</code> (localizado na pasta do sistema desktop)
                                </small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>Modo de Importa√ß√£o</strong></label>

                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="modo_importacao"
                                        id="modo_parcial_receitas"
                                        value="parcial"
                                        checked
                                    >
                                    <label class="form-check-label" for="modo_parcial_receitas">
                                        <strong>Parcial (Adicionar)</strong>
                                        <br>
                                        <small class="text-muted">Adiciona os dados do arquivo aos dados existentes (recomendado)</small>
                                    </label>
                                </div>

                                <div class="form-check mt-2">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="modo_importacao"
                                        id="modo_total_receitas"
                                        value="total"
                                    >
                                    <label class="form-check-label" for="modo_total_receitas">
                                        <strong>Total (Substituir)</strong>
                                        <br>
                                        <small class="text-danger">‚ö†Ô∏è APAGA todas as suas RECEITAS no servidor e substitui pelos dados do arquivo</small>
                                    </label>
                                </div>
                            </div>

                            <div class="alert alert-warning d-none" id="avisoTotalReceitas">
                                <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> O modo TOTAL ir√° apagar TODAS as suas RECEITAS antes de importar. Use apenas se tiver certeza!
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-cloud-upload"></i> üì§ Fazer Upload e Importar Receitas
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- NOVO: Download dos Bancos para Desktop -->
                <div class="card mb-4 border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-cloud-download"></i> üì• Baixar Bancos para Desktop</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è Download:</strong> Baixe seus dados do servidor para popular o sistema desktop.
                            <br><strong>Uso:</strong> √ötil para sincroniza√ß√£o inversa (Servidor ‚Üí Desktop)
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-danger">
                                            <i class="bi bi-wallet2"></i> Despesas
                                        </h5>
                                        <p class="card-text">
                                            <small class="text-muted">Baixar todas as suas despesas em formato SQLite</small>
                                        </p>
                                        <a href="{{ url_for('config.exportar_sqlite_despesas') }}" class="btn btn-danger">
                                            <i class="bi bi-download"></i> Baixar financas.db
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-success">
                                            <i class="bi bi-cash-coin"></i> Receitas
                                        </h5>
                                        <p class="card-text">
                                            <small class="text-muted">Baixar todas as suas receitas em formato SQLite</small>
                                        </p>
                                        <a href="{{ url_for('config.exportar_sqlite_receitas') }}" class="btn btn-success">
                                            <i class="bi bi-download"></i> Baixar financas_receita.db
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Separador -->
                <div class="text-center my-4">
                    <span class="badge bg-secondary">OU</span>
                </div>

                <!-- Importa√ß√£o de arquivos locais (m√©todo antigo) -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Importa√ß√£o de arquivos locais (servidor)</strong>
                    <p class="mb-0 mt-2">
                        Foram encontrados <strong>{{ total_arquivos }}</strong> arquivos de banco de dados na pasta do servidor.
                    </p>
                </div>

                <!-- Arquivos Encontrados -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Arquivos de Banco de Dados Dispon√≠veis</h5>
                    </div>
                    <div class="card-body">
                        {% if arquivos_db %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Arquivo</th>
                                        <th>Tipo</th>
                                        <th class="text-end">Tamanho</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for arquivo in arquivos_db %}
                                    <tr class="{% if arquivo.tipo == 'sistema_novo' %}table-warning{% endif %}">
                                        <td>
                                            <code>{{ arquivo.nome }}</code>
                                            {% if arquivo.tipo == 'sistema_novo' %}
                                            <span class="badge bg-warning text-dark">Atual</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if arquivo.tipo == 'despesas' %}
                                            <span class="badge bg-danger">Despesas</span>
                                            {% elif arquivo.tipo == 'receitas' %}
                                            <span class="badge bg-success">Receitas</span>
                                            {% elif arquivo.tipo == 'fluxo_caixa' %}
                                            <span class="badge bg-info">Fluxo Caixa</span>
                                            {% elif arquivo.tipo == 'sistema_novo' %}
                                            <span class="badge bg-warning text-dark">Sistema Novo</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Desconhecido</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">{{ "%.2f"|format(arquivo.tamanho_mb) }} MB</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">Nenhum arquivo .db encontrado na pasta do projeto.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Formul√°rio de Importa√ß√£o de Despesas e Receitas -->
                {% if arquivos_db %}
                <form method="POST" onsubmit="return confirmarImportacao();">
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-wallet2"></i> Importar Despesas e Receitas</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-wallet2 text-danger"></i>
                                        <strong>Banco de Despesas</strong>
                                    </label>
                                    <select class="form-select" name="caminho_financas" required>
                                        <option value="">Selecione...</option>
                                        {% for arquivo in arquivos_db %}
                                        {% if arquivo.tipo in ['despesas', 'desconhecido'] and arquivo.tipo !=
                                        'sistema_novo' %}
                                        <option value="{{ arquivo.caminho }}" {% if arquivo.nome=='financas.db'
                                            %}selected{% endif %}>
                                            {{ arquivo.nome }} ({{ "%.2f"|format(arquivo.tamanho_mb) }} MB)
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Selecione o banco que cont√©m as despesas</small>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="bi bi-cash-coin text-success"></i>
                                        <strong>Banco de Receitas</strong>
                                    </label>
                                    <select class="form-select" name="caminho_receitas" required>
                                        <option value="">Selecione...</option>
                                        {% for arquivo in arquivos_db %}
                                        {% if arquivo.tipo in ['receitas', 'desconhecido'] and arquivo.tipo !=
                                        'sistema_novo' %}
                                        <option value="{{ arquivo.caminho }}" {% if arquivo.nome=='financas_receitas.db'
                                            %}selected{% endif %}>
                                            {{ arquivo.nome }} ({{ "%.2f"|format(arquivo.tamanho_mb) }} MB)
                                        </option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Selecione o banco que cont√©m as receitas</small>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <h6><i class="bi bi-exclamation-triangle"></i> Avisos Importantes</h6>
                                <ul class="mb-0">
                                    <li>Os dados ser√£o importados para o usu√°rio <strong>{{ current_user.username
                                            }}</strong>
                                    </li>
                                    <li>Categorias e meios duplicados <strong>n√£o ser√£o reimportados</strong></li>
                                    <li>Despesas e receitas <strong>ser√£o adicionadas</strong> (pode gerar duplicatas se
                                        importar m√∫ltiplas vezes)</li>
                                    <li><strong>IMPORTANTE:</strong> Fa√ßa backup do banco <code>financeiro.db</code>
                                        antes de
                                        importar!</li>
                                </ul>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-download"></i> Importar Despesas e Receitas
                                </button>
                                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancelar
                                </a>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Formul√°rio de Importa√ß√£o de Fluxo de Caixa -->
                <form method="POST" onsubmit="return confirmarImportacaoFluxoCaixa();">
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Importar Fluxo de Caixa</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i>
                                <strong>Importa√ß√£o separada para dados de fluxo de caixa</strong><br>
                                Esta op√ß√£o importa balan√ßos mensais e eventos de caixa avulsos do sistema antigo.
                            </div>

                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-cash-stack text-info"></i>
                                    <strong>Banco de Fluxo de Caixa</strong>
                                </label>
                                <select class="form-select" name="caminho_fluxo_caixa" required>
                                    <option value="">Selecione...</option>
                                    {% for arquivo in arquivos_db %}
                                    {% if arquivo.tipo == 'fluxo_caixa' %}
                                    <option value="{{ arquivo.caminho }}" {% if arquivo.nome=='fluxo_caixa.db'
                                        %}selected{% endif %}>
                                        {{ arquivo.nome }} ({{ "%.2f"|format(arquivo.tamanho_mb) }} MB)
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Selecione o banco que cont√©m os dados de fluxo de
                                    caixa</small>
                            </div>

                            <div class="alert alert-warning">
                                <h6><i class="bi bi-exclamation-triangle"></i> Avisos</h6>
                                <ul class="mb-0">
                                    <li>Balan√ßos para meses j√° existentes <strong>n√£o ser√£o substitu√≠dos</strong></li>
                                    <li>Eventos de caixa <strong>ser√£o importados</strong> (pode gerar duplicatas)</li>
                                    <li><strong>Alternativa:</strong> Use o bot√£o "Recalcular Tudo" na p√°gina de Fluxo
                                        de Caixa</li>
                                </ul>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-info">
                                    <i class="bi bi-download"></i> Importar Fluxo de Caixa
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i>
                    <strong>Nenhum arquivo de banco de dados encontrado!</strong><br>
                    Copie os arquivos .db do sistema antigo para a pasta do projeto.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Informa√ß√µes Adicionais -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Sobre os Arquivos de Backup</h5>
            </div>
            <div class="card-body">
                <p>
                    O sistema antigo pode criar v√°rios arquivos de backup com nomes como:
                </p>
                <ul>
                    <li><code>financas.db</code> - Banco principal de despesas</li>
                    <li><code>financas_receitas.db</code> - Banco principal de receitas</li>
                    <li><code>fluxo_caixa.db</code> - Dados de fluxo de caixa</li>
                    <li><code>financas-NOMEMAQUINA.db</code> - Backup de despesas</li>
                    <li><code>financas_receitas-NOMEMAQUINA.db</code> - Backup de receitas</li>
                </ul>
                <p class="mb-0">
                    <strong>Recomenda√ß√£o:</strong> Use os arquivos principais que cont√™m os dados mais recentes.
                    Os backups s√≥ devem ser usados se os arquivos principais estiverem corrompidos.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmarImportacao() {
        const despesas = document.querySelector('select[name="caminho_financas"]').selectedOptions[0].text;
        const receitas = document.querySelector('select[name="caminho_receitas"]').selectedOptions[0].text;

        return confirm(`‚ö†Ô∏è CONFIRMA√á√ÉO DE IMPORTA√á√ÉO\n\n` +
            `Voc√™ est√° prestes a importar dados de:\n\n` +
            `Despesas: ${despesas}\n` +
            `Receitas: ${receitas}\n\n` +
            `Voc√™ fez backup do banco atual (financeiro.db)?\n\n` +
            `Deseja continuar?`);
    }

    function confirmarImportacaoFluxoCaixa() {
        const fluxoCaixa = document.querySelector('select[name="caminho_fluxo_caixa"]').selectedOptions[0].text;

        return confirm(`‚ö†Ô∏è CONFIRMA√á√ÉO DE IMPORTA√á√ÉO DE FLUXO DE CAIXA\n\n` +
            `Voc√™ est√° prestes a importar dados de:\n\n` +
            `Fluxo de Caixa: ${fluxoCaixa}\n\n` +
            `Balan√ßos e eventos ser√£o importados.\n\n` +
            `Deseja continuar?`);
    }

    // Aviso para modo total no upload - DESPESAS
    const modoTotalDespesas = document.getElementById('modo_total_despesas');
    const modoParcialDespesas = document.getElementById('modo_parcial_despesas');
    const avisoTotalDespesas = document.getElementById('avisoTotalDespesas');
    const formUploadDespesas = document.getElementById('formUploadDespesas');

    if (modoTotalDespesas && avisoTotalDespesas) {
        modoTotalDespesas.addEventListener('change', function() {
            if (this.checked) {
                avisoTotalDespesas.classList.remove('d-none');
            }
        });

        modoParcialDespesas.addEventListener('change', function() {
            if (this.checked) {
                avisoTotalDespesas.classList.add('d-none');
            }
        });

        // Confirmar antes de enviar no modo total
        formUploadDespesas.addEventListener('submit', function(e) {
            if (modoTotalDespesas.checked) {
                if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° APAGAR todas as suas DESPESAS atuais no servidor!\n\nTem certeza que deseja continuar?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    }

    // Aviso para modo total no upload - RECEITAS
    const modoTotalReceitas = document.getElementById('modo_total_receitas');
    const modoParcialReceitas = document.getElementById('modo_parcial_receitas');
    const avisoTotalReceitas = document.getElementById('avisoTotalReceitas');
    const formUploadReceitas = document.getElementById('formUploadReceitas');

    if (modoTotalReceitas && avisoTotalReceitas) {
        modoTotalReceitas.addEventListener('change', function() {
            if (this.checked) {
                avisoTotalReceitas.classList.remove('d-none');
            }
        });

        modoParcialReceitas.addEventListener('change', function() {
            if (this.checked) {
                avisoTotalReceitas.classList.add('d-none');
            }
        });

        // Confirmar antes de enviar no modo total
        formUploadReceitas.addEventListener('submit', function(e) {
            if (modoTotalReceitas.checked) {
                if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° APAGAR todas as suas RECEITAS atuais no servidor!\n\nTem certeza que deseja continuar?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    }
</script>
{% endblock %}