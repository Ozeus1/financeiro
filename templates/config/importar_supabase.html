{% extends "base.html" %}

{% block title %}Importar do Supabase{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-cloud-download-alt"></i> Importar Despesas do Supabase</h2>
    </div>

    <!-- Configuração -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Configuração da Conexão</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Método</label>
                    <select class="form-select" disabled>
                        <option selected>rest_api</option>
                    </select>
                </div>
                <div class="col-md-8 d-flex align-items-end justify-content-between">
                    <div id="status-conexao" class="text-muted">
                        Status: <span class="badge bg-secondary">Não conectado</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" id="btnSalvarConfig">
                            <i class="fas fa-save"></i> Salvar Config
                        </button>
                        <button class="btn btn-primary" id="btnCarregarDados">
                            <i class="fas fa-sync"></i> Carregar Dados
                        </button>
                        <button class="btn btn-info text-white" id="btnTestarConexao">
                            <i class="fas fa-plug"></i> Testar Conexão
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Nome da Tabela</label>
                <input type="text" class="form-control" id="supabase_table" value="{{ supabase_table }}"
                    placeholder="Ex: transacoes_financeiras">
            </div>

            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title">Configurações REST API</h6>
                    <div class="mb-2">
                        <label class="form-label">URL do Projeto</label>
                        <input type="text" class="form-control" id="supabase_url" value="{{ supabase_url }}"
                            placeholder="https://seu-projeto.supabase.co">
                    </div>
                    <div class="mb-0">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-control" id="supabase_key" value="{{ supabase_key }}"
                            placeholder="Sua API Key">
                    </div>
                </div>
            </div>

            <div class="mt-2 text-primary small">
                <i class="fas fa-lightbulb"></i> Dica: Dê duplo-clique em qualquer campo para editá-lo antes de importar
            </div>
        </div>
    </div>

    <!-- Tabela de Dados -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Dados para Importar</h5>
            <span class="badge bg-light text-dark" id="contador-registros">0 registros</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px;">
                <table class="table table-hover table-bordered mb-0" id="tabela-importacao">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="text-center" style="width: 50px;">
                                <input type="checkbox" id="check-todos">
                            </th>
                            <th>
                                Descrição
                                <input type="text" class="form-control form-control-sm mt-1 filter-input" data-col="1"
                                    placeholder="Filtrar...">
                            </th>
                            <th class="text-end">
                                Valor
                                <input type="text" class="form-control form-control-sm mt-1 filter-input" data-col="2"
                                    placeholder="Filtrar...">
                            </th>
                            <th>
                                Meio Pgto.
                                <input type="text" class="form-control form-control-sm mt-1 filter-input" data-col="3"
                                    placeholder="Filtrar...">
                            </th>
                            <th>
                                Categoria
                                <input type="text" class="form-control form-control-sm mt-1 filter-input" data-col="4"
                                    placeholder="Filtrar...">
                            </th>
                            <th class="text-center">
                                Parcelas
                                <input type="text" class="form-control form-control-sm mt-1 filter-input" data-col="5"
                                    placeholder="Filtrar...">
                            </th>
                            <th class="text-center">
                                Data Despesa
                                <input type="text" class="form-control form-control-sm mt-1 filter-input" data-col="6"
                                    placeholder="Filtrar...">
                            </th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-dados">
                        <tr>
                            <td colspan="8" class="text-center py-4 text-muted">
                                Clique em "Carregar Dados" para buscar registros do Supabase
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between">
                <div>
                    <button class="btn btn-success" id="btnImportarSelecionados">
                        Importar Selecionados
                    </button>
                    <button class="btn btn-danger" id="btnExcluirSelecionados">
                        Excluir Selecionados
                    </button>
                    <button class="btn btn-outline-success" id="btnImportarTodos">
                        Importar Todos
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="window.history.back()">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const btnSalvar = document.getElementById('btnSalvarConfig');
        const btnTestar = document.getElementById('btnTestarConexao');
        const btnCarregar = document.getElementById('btnCarregarDados');
        const btnImportarSel = document.getElementById('btnImportarSelecionados');
        const btnExcluirSel = document.getElementById('btnExcluirSelecionados');
        const btnImportarTodos = document.getElementById('btnImportarTodos');
        const checkTodos = document.getElementById('check-todos');
        const tbody = document.getElementById('tbody-dados');
        const loading = document.getElementById('loading-overlay');
        const statusDiv = document.getElementById('status-conexao');

        function showLoading() { loading.style.display = 'flex'; }
        function hideLoading() { loading.style.display = 'none'; }

        function getConfig() {
            return {
                url: document.getElementById('supabase_url').value,
                key: document.getElementById('supabase_key').value,
                table: document.getElementById('supabase_table').value
            };
        }

        // Salvar Configuração
        btnSalvar.addEventListener('click', function () {
            showLoading();
            fetch('{{ url_for("config.salvar_config_supabase") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(getConfig())
            })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.success) alert('Configuração salva com sucesso!');
                    else alert('Erro ao salvar: ' + data.message);
                })
                .catch(err => {
                    hideLoading();
                    alert('Erro: ' + err);
                });
        });

        // Testar Conexão
        btnTestar.addEventListener('click', function () {
            showLoading();
            fetch('{{ url_for("config.testar_conexao_supabase") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(getConfig())
            })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        statusDiv.innerHTML = 'Status: <span class="badge bg-success">Conectado via REST API</span>';
                        alert(data.message);
                    } else {
                        statusDiv.innerHTML = 'Status: <span class="badge bg-danger">Erro de Conexão</span>';
                        alert(data.message);
                    }
                })
                .catch(err => {
                    hideLoading();
                    alert('Erro: ' + err);
                });
        });

        // Carregar Dados
        btnCarregar.addEventListener('click', function () {
            showLoading();
            fetch('{{ url_for("config.buscar_dados_supabase") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(getConfig())
            })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        renderTable(data.data);
                        document.getElementById('contador-registros').textContent = `${data.data.length} registros`;
                    } else {
                        alert('Erro ao buscar dados: ' + data.message);
                    }
                })
                .catch(err => {
                    hideLoading();
                    alert('Erro: ' + err);
                });
        });

        function renderTable(items) {
            tbody.innerHTML = '';
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum dado encontrado</td></tr>';
                return;
            }

            items.forEach(item => {
                // Formatar valor
                let valor = parseFloat(item.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });

                // Formatar data
                let dataDespesa = item.data_despesa || '';
                if (dataDespesa.includes('T')) dataDespesa = dataDespesa.split('T')[0];
                // Converter YYYY-MM-DD para DD/MM/YYYY para exibição
                if (dataDespesa.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parts = dataDespesa.split('-');
                    dataDespesa = `${parts[2]}/${parts[1]}/${parts[0]}`;
                }

                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                tr.innerHTML = `
                <td class="text-center"><input type="checkbox" class="check-item"></td>
                <td contenteditable="true" class="editable" data-field="descricao">${item.descricao || ''}</td>
                <td contenteditable="true" class="editable text-end" data-field="valor">${valor}</td>
                <td contenteditable="true" class="editable" data-field="meio_pagamento">${item.forma_pagamento || 'Outros'}</td>
                <td contenteditable="true" class="editable" data-field="categoria">${item.conta_despesa || 'Outros'}</td>
                <td contenteditable="true" class="editable text-center" data-field="parcelas">${item.numero_parcelas || 1}</td>
                <td contenteditable="true" class="editable text-center" data-field="data_despesa">${dataDespesa}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-danger btn-excluir" title="Excluir do Supabase">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            });

            // Adicionar eventos de exclusão
            document.querySelectorAll('.btn-excluir').forEach(btn => {
                btn.addEventListener('click', function () {
                    if (confirm('Tem certeza que deseja excluir este item do Supabase?')) {
                        const tr = this.closest('tr');
                        const id = tr.dataset.id;
                        excluirItem(id, tr);
                    }
                });
            });
        }

        function excluirItem(id, tr) {
            showLoading();
            fetch('{{ url_for("config.excluir_item_supabase") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: id,
                    config: getConfig()
                })
            })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        tr.remove();
                    } else {
                        alert('Erro ao excluir: ' + data.message);
                    }
                })
                .catch(err => {
                    hideLoading();
                    alert('Erro: ' + err);
                });
        }

        // Selecionar Todos
        checkTodos.addEventListener('change', function () {
            document.querySelectorAll('.check-item').forEach(check => {
                check.checked = this.checked;
            });
        });

        // Importar
        function importar(selecionadosApenas) {
            const items = [];
            const rows = document.querySelectorAll('#tbody-dados tr');

            rows.forEach(row => {
                const checkbox = row.querySelector('.check-item');
                if (!checkbox) return; // Skip empty message row
                if (row.style.display === 'none') return; // Skip hidden rows (filtered)

                if (selecionadosApenas && !checkbox.checked) return;

                items.push({
                    id: row.dataset.id,
                    descricao: row.querySelector('[data-field="descricao"]').innerText,
                    valor: row.querySelector('[data-field="valor"]').innerText,
                    meio_pagamento: row.querySelector('[data-field="meio_pagamento"]').innerText,
                    categoria: row.querySelector('[data-field="categoria"]').innerText,
                    parcelas: row.querySelector('[data-field="parcelas"]').innerText,
                    data_despesa: row.querySelector('[data-field="data_despesa"]').innerText
                });
            });

            if (items.length === 0) {
                alert('Nenhum item selecionado para importação.');
                return;
            }

            if (!confirm(`Deseja importar ${items.length} itens?`)) return;

            showLoading();
            fetch('{{ url_for("config.importar_dados_supabase") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: items,
                    config: getConfig()
                })
            })
                .then(r => r.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        alert(data.message);
                        // Opcional: Recarregar dados ou remover itens importados da lista
                        btnCarregar.click();
                    } else {
                        alert('Erro na importação: ' + data.message);
                        if (data.erros) console.log(data.erros);
                    }
                })
                .catch(err => {
                    hideLoading();
                    alert('Erro: ' + err);
                });
        }

        btnImportarSel.addEventListener('click', () => importar(true));
        btnImportarTodos.addEventListener('click', () => importar(false));

        // Excluir Selecionados
        btnExcluirSel.addEventListener('click', function () {
            const selecionados = [];
            document.querySelectorAll('.check-item:checked').forEach(checkbox => {
                const tr = checkbox.closest('tr');
                // Only include visible rows
                if (tr.style.display !== 'none') {
                    selecionados.push({
                        id: tr.dataset.id,
                        element: tr
                    });
                }
            });

            if (selecionados.length === 0) {
                alert('Nenhum item selecionado para exclusão.');
                return;
            }

            if (!confirm(`Tem certeza que deseja excluir ${selecionados.length} itens do Supabase?`)) return;

            showLoading();
            let excluidos = 0;
            let erros = 0;

            // Processar exclusões em sequência para não sobrecarregar
            const processarExclusao = async () => {
                for (const item of selecionados) {
                    try {
                        const response = await fetch('{{ url_for("config.excluir_item_supabase") }}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: item.id,
                                config: getConfig()
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            item.element.remove();
                            excluidos++;
                        } else {
                            erros++;
                        }
                    } catch (e) {
                        erros++;
                    }
                }

                hideLoading();
                alert(`${excluidos} itens excluídos com sucesso.${erros > 0 ? `\n${erros} erros.` : ''}`);

                // Atualizar contador
                const total = document.querySelectorAll('#tbody-dados tr').length;
                const contador = document.getElementById('contador-registros');
                if (contador) contador.textContent = `${total} registros`;
            };

            processarExclusao();
        });

        // Filtragem
        document.querySelectorAll('.filter-input').forEach(input => {
            input.addEventListener('keyup', function () {
                const termo = this.value.toLowerCase();
                const colIndex = this.dataset.col;
                const rows = tbody.getElementsByTagName('tr');

                Array.from(rows).forEach(row => {
                    if (row.cells.length < 8) return; // Ignorar linha de "Nenhum dado"

                    // Lógica de filtro: mostrar se corresponder ao termo
                    // Mas precisamos considerar todos os filtros ativos
                    let mostrar = true;

                    // Verificar todos os inputs de filtro
                    document.querySelectorAll('.filter-input').forEach(filter => {
                        if (filter.value) {
                            const filterCol = filter.dataset.col;
                            const filterTerm = filter.value.toLowerCase();
                            const targetCell = row.cells[filterCol];
                            if (targetCell) {
                                const targetText = targetCell.textContent || targetCell.innerText;
                                if (!targetText.toLowerCase().includes(filterTerm)) {
                                    mostrar = false;
                                }
                            }
                        }
                    });

                    row.style.display = mostrar ? '' : 'none';
                });
            });
        });
    });
</script>

<style>
    .editable {
        background-color: #fff;
        cursor: text;
    }

    .editable:focus {
        background-color: #e8f0fe;
        outline: 2px solid #0d6efd;
        padding: 2px;
    }
</style>
{% endblock %}