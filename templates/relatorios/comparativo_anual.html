{% extends "base.html" %}

{% block title %}Comparativo Anual{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2><i class="bi bi-calendar-range"></i> Comparativo de Gastos Mensais por Ano</h2>
        <hr>
    </div>
</div>

{% if not anos %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Não há dados suficientes para gerar o comparativo anual.
            Você precisa ter despesas cadastradas em pelo menos um ano.
        </div>
    </div>
</div>
{% else %}
<!-- Anos Disponíveis -->
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Anos com Dados</h5>
                <p class="mb-2">
                    {% for ano in anos %}
                    <span class="badge bg-primary fs-6 me-2">{{ ano }}</span>
                    {% endfor %}
                </p>
                <small class="text-muted">
                    O gráfico compara os gastos mensais entre os anos com dados disponíveis.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico -->
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Comparativo Mensal por Ano</h5>
                <canvas id="chartComparativo" height="70"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Legenda Explicativa -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-lightbulb"></i> Como Interpretar</h5>
                <ul>
                    <li><strong>Barras Agrupadas:</strong> Cada grupo representa um mês, com uma barra para cada ano.</li>
                    <li><strong>Comparação Direta:</strong> Compare visualmente os gastos do mesmo mês em diferentes anos.</li>
                    <li><strong>Tendências:</strong> Identifique padrões sazonais e variações ao longo dos anos.</li>
                    <li><strong>Passe o mouse:</strong> Visualize os valores exatos de cada barra.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if anos %}
<script>
// Gráfico de Barras Agrupadas
const ctx = document.getElementById('chartComparativo').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ chart_labels | tojson }},
        datasets: {{ datasets | tojson }}
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    }
                }
            },
            x: {
                ticks: {
                    maxRotation: 0,
                    minRotation: 0
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
