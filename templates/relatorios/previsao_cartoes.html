{% extends "base.html" %}

{% block title %}Previsão de Faturas de Cartão{% endblock %}

{% block extra_css %}
<style>
    .cursor-pointer {
        cursor: pointer;
    }

    .hover-highlight:hover {
        background-color: #f8f9fa;
    }

    .fatura-fechada {
        color: #6c757d;
        text-decoration: line-through;
    }

    .fatura-prevista {
        color: #0d6efd;
        font-weight: 500;
    }

    .card-fatura {
        transition: transform 0.2s;
    }

    .card-fatura:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2><i class="bi bi-credit-card"></i> Previsão de Faturas</h2>
        <p class="text-muted">Acompanhamento detalhado por cartão. Clique no valor para ver os itens da fatura.</p>
        <hr>
    </div>
</div>

{% if not previsoes %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>Nenhum cartão configurado.</strong><br>
    Configure os cartões em: Configurações > Configurar Cartões
</div>
{% else %}

<!-- Tabela de Resumo Global -->
{% if resumo_global and resumo_global.detalhes_mensais %}
<div class="card mb-4 shadow-lg border-primary">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h4 class="mb-0"><i class="bi bi-calculator"></i> Resumo Global - Faturas Previstas</h4>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-light" onclick="toggleAllCards(true)">
                    <i class="bi bi-chevron-down"></i> Expandir Todos
                </button>
                <button type="button" class="btn btn-sm btn-light" onclick="toggleAllCards(false)">
                    <i class="bi bi-chevron-up"></i> Recolher Todos
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th><i class="bi bi-calendar-month"></i> Mês/Ano</th>
                        <th class="text-end"><i class="bi bi-cash-stack"></i> Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in resumo_global.detalhes_mensais %}
                    <tr>
                        <td class="fw-bold">{{ item.mes_referencia }}</td>
                        <td class="text-end text-primary fw-bold">R$ {{ "%.2f"|format(item.total)|replace('.', ',') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-active">
                        <td class="fw-bold fs-5">TOTAL GERAL</td>
                        <td class="text-end fw-bold fs-5 text-success">R$ {{
                            "%.2f"|format(resumo_global.total_geral)|replace('.', ',') }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Cards por Cartão -->
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
    {% for cartao in previsoes %}
    <div class="col">
        <div class="card h-100 shadow-sm card-fatura">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-card-heading"></i> {{ cartao.cartao }}</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="toggleCard({{ loop.index }})"
                        id="toggle-btn-{{ loop.index }}" title="Mostrar/Ocultar">
                        <i class="bi bi-chevron-up" id="toggle-icon-{{ loop.index }}"></i>
                    </button>
                </div>
            </div>
            <div class="collapse show" id="card-body-{{ loop.index }}">
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Mês/Ano</th>
                                    <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fatura in cartao.faturas %}
                                <tr class="cursor-pointer hover-highlight"
                                    onclick="verDetalhes({{ cartao.cartao_id }}, {{ fatura.mes_int }}, {{ fatura.ano_int }}, '{{ cartao.cartao | replace("'", "") }}'
                                    , '{{ fatura.mes_referencia }}' )">
                                    <td>
                                        <span class="fw-bold">{{ fatura.mes_referencia }}</span>
                                        <br>
                                        <small class="text-muted" style="font-size: 0.75rem;">Venc: {{
                                            fatura.vencimento.strftime('%d/%m') }}</small>
                                    </td>
                                    <td class="text-end align-middle">
                                        {% if fatura.total > 0 %}
                                        <span
                                            class="{% if fatura.status == 'Fechada' %}fatura-fechada{% else %}fatura-prevista{% endif %}">
                                            R$ {{ "%.2f"|format(fatura.total)|replace('.', ',') }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Área do Gráfico -->
            <div class="p-3 border-top bg-white">
                <h6 class="text-muted small mb-2"><i class="bi bi-graph-up"></i> Evolução Mensal</h6>
                <div style="height: 200px;">
                    <canvas id="chart-{{ loop.index }}"></canvas>
                </div>
            </div>
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Restante (Próx. Mês+):</small>
                    <span class="fw-bold text-primary fs-5">R$ {{ "%.2f"|format(cartao.total_restante)|replace('.',
                        ',')
                        }}</span>
                </div>
            </div>
        </div> <!-- Fim do collapse -->
    </div>
</div>
{% endfor %}
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitulo">Detalhes da Fatura</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loadingDetalhes" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando transações...</p>
                </div>
                <div id="conteudoDetalhes" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrição</th>
                                    <th>Categoria</th>
                                    <th>Parcela</th>
                                    <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaTransacoes">
                                <!-- Preenchido via JS -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active fw-bold">
                                    <td colspan="4" class="text-end">TOTAL</td>
                                    <td class="text-end" id="totalFaturaModal">R$ 0,00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
{% if previsoes %}
<!-- Carregar Chart.js (caso ainda não esteja carregado no base) -->
<!-- Garantido no base.html -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar gráficos para cada cartão
        {% for cartao in previsoes %}
        (function () {
            const ctx = document.getElementById('chart-{{ loop.index }}').getContext('2d');
            const labels = {{ cartao.labels_grafico | tojson
        }};
    const data = {{ cartao.dados_grafico | tojson }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor (R$)',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return 'R$ ' + context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        drawBorder: false
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        callback: function (value) {
                            if (value >= 1000) return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                            return value;
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
        }) ();
    {% endfor %}
    });
</script>
<script>
    // Função para togglear visibilidade de card individual
    function toggleCard(index) {
        const element = document.getElementById(`card-body-${index}`);
        const icon = document.getElementById(`toggle-icon-${index}`);

        const bsCollapse = new bootstrap.Collapse(element, {
            toggle: true
        });

        // Atualizar ícone após a transição
        element.addEventListener('shown.bs.collapse', function () {
            icon.classList.remove('bi-chevron-down');
            icon.classList.add('bi-chevron-up');
        }, { once: true });

        element.addEventListener('hidden.bs.collapse', function () {
            icon.classList.remove('bi-chevron-up');
            icon.classList.add('bi-chevron-down');
        }, { once: true });
    }

    // Função para expandir ou recolher todos os cards
    function toggleAllCards(expand) {
        const cards = document.querySelectorAll('[id^="card-body-"]');
        cards.forEach((card, index) => {
            const actualIndex = index + 1;
            const icon = document.getElementById(`toggle-icon-${actualIndex}`);

            if (expand && !card.classList.contains('show')) {
                new bootstrap.Collapse(card, { toggle: true });
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else if (!expand && card.classList.contains('show')) {
                new bootstrap.Collapse(card, { toggle: true });
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
        });
    }

    // Função para abrir modal de detalhes
    function verDetalhes(cartaoId, mes, ano, nomeCartao, mesRef) {
        // Configurar modal
        document.getElementById('modalTitulo').textContent = `Fatura ${nomeCartao} - ${mesRef}`;
        document.getElementById('loadingDetalhes').style.display = 'block';
        document.getElementById('conteudoDetalhes').style.display = 'none';

        const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        modal.show();

        // Buscar dados
        fetch(`/relatorios/api/fatura-detalhes/${cartaoId}/${mes}/${ano}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('tabelaTransacoes');
                tbody.innerHTML = '';

                let total = 0;

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhuma transação encontrada.</td></tr>';
                } else {
                    data.forEach(item => {
                        total += item.valor;
                        const row = `
                            <tr>
                                <td>${item.data}</td>
                                <td>${item.descricao}</td>
                                <td><span class="badge bg-light text-dark border">${item.categoria}</span></td>
                                <td>${item.parcelas}</td>
                                <td class="text-end">R$ ${item.valor.toFixed(2).replace('.', ',')}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                }

                document.getElementById('totalFaturaModal').textContent =
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total);

                document.getElementById('loadingDetalhes').style.display = 'none';
                document.getElementById('conteudoDetalhes').style.display = 'block';
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('loadingDetalhes').innerHTML =
                    '<div class="alert alert-danger">Erro ao carregar detalhes. Tente novamente.</div>';
            });
    }
</script>
{% endif %}
{% endblock %}